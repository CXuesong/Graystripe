{"version":3,"sources":["script/ptag.ts"],"names":[],"mappings":"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","file":"ptag.js","sourcesContent":["/// <reference path=\"../../typings/index.d.ts\"/>\r\nimport * as ObjectModel from \"./objectModel\";\r\nimport * as Utility from \"./utility\";\r\nimport * as Locale from \"./locale\";\r\n\r\n/**\r\n * An immutable strcutre of full game-stage name.\r\n *\r\n * The full game-stage expression obeys the following syntax\r\n * `[`_`groupName`_`:][`_`localName`_]\r\n * the `groupName` can be neglected, which indicates a\r\n * relative stage name.\r\n */\r\nexport class StageName {\r\n    public static Combine(stage1: StageName, stage2: StageName) {\r\n        if (stage2.isRelative)\r\n            return new StageName(stage1._groupName, stage2._localName);\r\n        return stage2;\r\n    }\r\n\r\n    public constructor(groupName: string, localName: string);\r\n    public constructor(stageExpr: string);\r\n    public constructor(private readonly _groupName: string, private readonly _localName?: string) {\r\n        if (_localName === undefined) {\r\n            // Parse\r\n            let segments = _groupName.split(\":\", 2);\r\n            if (segments.length >= 2) {\r\n                this._groupName = segments[0];\r\n                this._localName = segments[1];\r\n            } else {\r\n                this._groupName = null;\r\n                this._localName = segments[0];\r\n            }\r\n        }\r\n        if (_groupName === undefined) this._groupName = null;\r\n    }\r\n    public get groupName() { return this._groupName; }\r\n    public get localName() { return this._localName; }\r\n    public get isRelative() { return this._groupName === null; }\r\n    public toString() {\r\n        if (this._groupName === null) return this._localName;\r\n        return this._groupName + \":\" + this._localName;\r\n    }\r\n}\r\n\r\nexport class StageMissingError extends Utility.ResourceMissingError {\r\n    public constructor(public stageName: StageName) {\r\n        super(stageName, \"Stage\");\r\n    }\r\n}\r\n\r\nexport class StageGroupMissingError extends Utility.ResourceMissingError {\r\n    public constructor(public stageGroupName: string) {\r\n        super(stageGroupName, \"StageGroup\");\r\n    }\r\n}\r\n\r\n/**\r\n * Mutable stage state.\r\n */\r\nexport class StageContext {\r\n    public rootUrl: string;\r\n    public currentStage: StageName;\r\n    public stateStore: { [key: string]: any } = {};\r\n    // Current Stage\r\n    public prompt: string;\r\n    public options: ObjectModel.StageOption[];\r\n    // Utility\r\n    public getAbsUrl(path: string) {\r\n        return new URI(this.rootUrl).filename(path).toString();\r\n    }\r\n    public clear() {\r\n        this.rootUrl = null;\r\n        this.currentStage = null;\r\n        this.stateStore = {};\r\n        this.prompt = null;\r\n        this.options = null;\r\n    }\r\n    public constructor() {\r\n        this.clear();\r\n    }\r\n}\r\n\r\n/**\r\n * The adventure game engine.\r\n */\r\nexport class GameEngine implements Locale.LocaleAware {\r\n    private readonly _context = new StageContext();\r\n    private _game: ObjectModel.GameMeta;\r\n    private _loadedStageGroups: { [name: string]: ObjectModel.StageGroup } = {};\r\n    private readonly _loadingStageGroups: { [name: string]: { [locale: string]: JQueryPromise<any> } } = {};\r\n    private _currentLocale = \"\";\r\n\r\n    public constructor() {\r\n        this.clear();\r\n    }\r\n\r\n    public getCurrentLocale() {\r\n        return this._currentLocale;\r\n    }\r\n\r\n    public setCurrentLocaleAsync(locale: string) {\r\n        if (locale === this._currentLocale) return $.Deferred().resolve();\r\n        this._currentLocale = Locale.normalizeLanguageTag(locale);\r\n        if (!!this._game) {\r\n            // TODO Distingush between GOTO and REFRESH the current stage.\r\n            return this.gotoStageAsync(this._context.currentStage);\r\n        }\r\n        return $.Deferred().resolve();\r\n    }\r\n\r\n    public clear() {\r\n        this._loadedStageGroups = {};\r\n        this._game = null;\r\n        this._context.clear();\r\n    }\r\n\r\n    public openGameAsync(url: string) {\r\n        return Utility.getJson(url).then((json) => {\r\n            this._game = <ObjectModel.GameMeta>json;\r\n            this._context.rootUrl = new URI(url).hash(\"\").search(\"\").filename(\"\").toString();\r\n            return this.gotoStageAsync(new StageName(\":\"));\r\n        });\r\n    }\r\n\r\n    public tryGetLocalizedStageGroupAsync(groupName: string, locale: string): JQueryPromise<ObjectModel.LocalizedStageGroup> {\r\n        console.assert(!!this._game);\r\n        let group = this._loadedStageGroups[groupName];\r\n        if (group !== undefined) {\r\n            let lg = group.localized[locale];\r\n            if (lg) return $.Deferred().resolve(lg);\r\n        }\r\n        let dg = (this._loadingStageGroups[groupName] || {})[locale];\r\n        if (dg) return dg;\r\n        // Fetch\r\n        let importUrl = new URI(this._context.getAbsUrl(this._game.stageGroups[groupName]));\r\n        importUrl.filename(Utility.fileNameAddSuffix(importUrl.filename(), \".\" + locale));\r\n        if (!importUrl) return $.Deferred().reject(new StageGroupMissingError(groupName));\r\n        return this._loadingStageGroups[groupName][locale] = this.getStageGroupAsync(groupName).then(g => {\r\n            group = g;\r\n            return Utility.getJson(importUrl.toString());\r\n        }).then(json => { return group.localized[locale] = json; }, err => {\r\n            console.log(\"tryGetLocalizedStageGroupAsync\", err);\r\n            let netErr = <Utility.NetError>err;\r\n            // Resource not found, etc.\r\n            if (netErr.IsBadRequest) return group.localized[locale] = null;\r\n            // Network failure, perhaps.\r\n            return null;\r\n        });\r\n    }\r\n\r\n    public getStageGroupAsync(groupName: string) {\r\n        console.assert(!!this._game);\r\n        let group = this._loadedStageGroups[groupName];\r\n        if (group) return $.Deferred().resolve(group);\r\n        let dg = (this._loadingStageGroups[groupName] || {})[\"*\"];\r\n        if (dg) return dg;\r\n        let importUrl = this._game.stageGroups[groupName];\r\n        if (!importUrl) return $.Deferred().reject(new StageGroupMissingError(groupName));\r\n        if (!this._loadingStageGroups[groupName]) this._loadingStageGroups[groupName] = {};\r\n        return this._loadingStageGroups[groupName][\"*\"] = Utility.getJson(this._context.getAbsUrl(importUrl))\r\n            .then((json: ObjectModel.StageGroup) => {\r\n                json.sourceUrl = this._context.getAbsUrl(importUrl);\r\n                json.localized = {};\r\n                return this._loadedStageGroups[groupName] = json;\r\n            });\r\n    }\r\n\r\n    public getStageAsync(name: StageName): JQueryPromise<ObjectModel.GameStage> {\r\n        let d = $.Deferred();\r\n        // The 'arguments' object cannot be referenced in an arrow function in ES3 and ES5.\r\n        this.getStageGroupAsync(name.groupName).then(group => {\r\n            let s = group.stages[name.localName];\r\n            if (s) d.resolve(s);\r\n            else d.reject(new StageMissingError(name));\r\n        }, function () { d.reject.apply(d, arguments); });\r\n        return d;\r\n    }\r\n\r\n    /**\r\n     * Goes to the startup stage of the game.\r\n     */\r\n    public gotoStageAsync(): JQueryPromise<{}>;\r\n    /**\r\n     * Goes to a specific stage of the game.\r\n     */\r\n    public gotoStageAsync(name: StageName): JQueryPromise<{}>;\r\n    public gotoStageAsync(name?: StageName) {\r\n        if (name)\r\n            name = StageName.Combine(this._context.currentStage, name);\r\n        else\r\n            name = new StageName(\":\");\r\n        console.log(\"gotoStageAsync %s\", name.toString());\r\n        let stage: ObjectModel.GameStage;\r\n        let newPrompt: string;\r\n        let newOptionsText: string[] = [];\r\n        return this.getStageAsync(name).then(s => {\r\n            stage = s;\r\n            newPrompt = stage.prompt;\r\n            newOptionsText = stage.options.map(opt => { return opt.text; });\r\n            if (!this._currentLocale || Locale.languageTagEquals(this._game.lang.default, this._currentLocale)) return;\r\n            // Need localization\r\n            let ds = [this.getLocalizedStageGroupValueAsync(name.groupName, lsg => newPrompt = lsg.stages[name.localName].prompt)];\r\n            for (let i = 0; i < stage.options.length; i++) {\r\n                let i1 = i;\r\n                ds.push(this.getLocalizedStageGroupValueAsync(name.groupName, lsg =>\r\n                    newOptionsText[i1] = lsg.stages[name.localName].options[i1]));\r\n            }\r\n            return $.when.apply($, ds);\r\n        }).then(() => {\r\n            if (stage) {\r\n                this._context.prompt = newPrompt;\r\n                this._context.options = stage.options.map((opt, i) => {\r\n                    return <ObjectModel.StageOption>{ target: opt.target, text: newOptionsText[i] };\r\n                });\r\n                // eval(stage.script);\r\n                this._context.currentStage = name;\r\n                return;\r\n            }\r\n            return $.Deferred().reject(new StageMissingError(name));\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Persists current state into an object dictionary and returns it.\r\n     */\r\n    public saveContext() {\r\n        return { currentStage: this._context.currentStage.toString(), stateStore: this._context.stateStore };\r\n    }\r\n    /**\r\n     * Load current stage from an object dictionary.\r\n     */\r\n    public loadContextAsync(obj: any) {\r\n        this._context.stateStore = obj.stateStore || {};\r\n        return this.gotoStageAsync(new StageName(obj.currentStage || \":\"));\r\n    }\r\n\r\n    public get context() { return this._context; }\r\n\r\n    private getLocalizedStageGroupValueAsync<T>(groupName: string,\r\n        selector: (lsg: ObjectModel.LocalizedStageGroup) => T, fallback?: T, locale?: string) {\r\n        locale = locale || this._currentLocale;\r\n        let attempts = 0;\r\n        //  states\r\n        //      0       original\r\n        //      1       surrogate\r\n        //      2       fallback + surrogate\r\n        let nextAttempt = (lsg: ObjectModel.LocalizedStageGroup): T | JQueryPromise<T> => {\r\n            if (!lsg) {\r\n                while (attempts < 2) {\r\n                    let lc: string;\r\n                    switch (attempts) {\r\n                        case 0: lc = locale; break;\r\n                        case 1: lc = Locale.getSurrogateLanguage(locale); break;\r\n                        case 2: lc = Locale.getSurrogateLanguage(Locale.fallbackLanguageTag(locale)); break;\r\n                    }\r\n                    // Next state\r\n                    attempts++;\r\n                    // This attempt is to failâ€¦\r\n                    if (!lc) continue;\r\n                    // May worth a trial.\r\n                    lc = Locale.findLanguageTag(lc, this._game.lang.supported);\r\n                    if (lc) {\r\n                        console.log(\"getLocalizedStageGroupValueAsync\", \"try locale\", lc);\r\n                        return this.tryGetLocalizedStageGroupAsync(groupName, lc).then(nextAttempt);\r\n                    }\r\n                };\r\n                return fallback;\r\n            }\r\n            return selector(lsg);\r\n        };\r\n        return $.Deferred().resolve().then(nextAttempt);\r\n    }\r\n\r\n    public get supportedLocales() {\r\n        return this._game.lang.supported;\r\n    }\r\n}\r\n\r\n/**\r\n * Converts the short-hand markup to standard HTML.\r\n */\r\nexport function parseMarkup(mk: string) {\r\n    let x = $.parseXML(\"<div>\" + mk + \"</div>\");\r\n    $(\"a[href]\", x).attr(\"target\", \"_blank\");\r\n    return Utility.XmlToString(x);\r\n}\r\n"]}