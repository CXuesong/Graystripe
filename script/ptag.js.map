{"version":3,"sources":["script/ptag.ts"],"names":[],"mappings":"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","file":"ptag.js","sourcesContent":["/// <reference path=\"../../typings/index.d.ts\"/>\r\nimport * as ObjectModel from \"./objectModel\";\r\nimport * as Utility from \"./utility\";\r\n\r\n/**\r\n * An immutable strcutre of full game-stage name.\r\n *\r\n * The full game-stage expression obeys the following syntax\r\n * `[`_`groupName`_`:][`_`localName`_]\r\n * the `groupName` can be neglected, which indicates a\r\n * relative stage name.\r\n */\r\nexport class StageName {\r\n    public static Combine(stage1: StageName, stage2: StageName) {\r\n        if (stage2.isRelative)\r\n            return new StageName(stage1._groupName, stage2._localName);\r\n        return stage2;\r\n    }\r\n\r\n    public constructor(groupName: string, localName: string);\r\n    public constructor(stageExpr: string);\r\n    public constructor(private readonly _groupName: string, private readonly _localName?: string) {\r\n        if (_localName === undefined) {\r\n            // Parse\r\n            let segments = _groupName.split(\":\", 2);\r\n            if (segments.length >= 2) {\r\n                this._groupName = segments[0];\r\n                this._localName = segments[1];\r\n            } else {\r\n                this._groupName = null;\r\n                this._localName = segments[0];\r\n            }\r\n        }\r\n        if (_groupName === undefined) this._groupName = null;\r\n    }\r\n    public get groupName() { return this._groupName; }\r\n    public get localName() { return this._localName; }\r\n    public get isRelative() { return this._groupName === null; }\r\n    public toString() {\r\n        if (this._groupName === null) return this._localName;\r\n        return this._groupName + \":\" + this._localName;\r\n    }\r\n}\r\n\r\nexport class StageMissingError extends Utility.ResourceMissingError {\r\n    public constructor(public stageName: StageName) {\r\n        super(stageName, \"Stage\");\r\n    }\r\n}\r\n\r\nexport class StageGroupMissingError extends Utility.ResourceMissingError {\r\n    public constructor(public stageGroupName: string) {\r\n        super(stageGroupName, \"StageGroup\");\r\n    }\r\n}\r\n\r\n/**\r\n * Mutable stage state.\r\n */\r\nexport class StageContext {\r\n    public rootUrl: string;\r\n    public currentStage: StageName;\r\n    public stateStore: { [key: string]: any } = {};\r\n    // Current Stage\r\n    public prompt: string;\r\n    public options: ObjectModel.StageOption[];\r\n    public getAbsUrl(path: string) {\r\n        return new URI(this.rootUrl).filename(path).toString();\r\n    }\r\n    public constructor() {\r\n\r\n    }\r\n}\r\n\r\n/**\r\n * The adventure game engine.\r\n */\r\nexport class GameEngine {\r\n    private _context: StageContext;\r\n    private _game: ObjectModel.GameMeta;\r\n    private _loadedStageGroups: { [name: string]: ObjectModel.StageGroup | JQueryPromise<ObjectModel.StageGroup> };\r\n\r\n    public constructor() {\r\n        this.clear();\r\n    }\r\n\r\n    public clear() {\r\n        this._context = new StageContext();\r\n        this._loadedStageGroups = {};\r\n        this._game = null;\r\n    }\r\n\r\n    public openGameAsync(url: string) {\r\n        return Utility.getJson(url).then((json) => {\r\n            this._game = <ObjectModel.GameMeta>json;\r\n            this._context.rootUrl = new URI(url).hash(\"\").search(\"\").filename(\"\").toString();\r\n            return this.gotoStageAsync(new StageName(\":\"));\r\n        });\r\n    }\r\n\r\n    public getStageGroupAsync(groupName: string) {\r\n        if (!this._game) return $.Deferred().reject(new Error(\"Game is not ready.\"));\r\n        let group = this._loadedStageGroups[groupName];\r\n        if (!group) {\r\n            let importUrl = this._game.stageGroups[groupName];\r\n            if (!importUrl) return $.Deferred().reject(new StageGroupMissingError(groupName));\r\n            return this._loadedStageGroups[groupName] = Utility.getJson(this._context.getAbsUrl(importUrl))\r\n                .then(json => { return this._loadedStageGroups[groupName] = <ObjectModel.StageGroup>json; });\r\n        }\r\n        if ((<JQueryPromise<ObjectModel.StageGroup>>group).then)\r\n            return <JQueryPromise<ObjectModel.StageGroup>>group;\r\n        else\r\n            return $.Deferred().resolve(group);\r\n    }\r\n\r\n    public gotoStageAsync(name: StageName) {\r\n        name = StageName.Combine(this._context.currentStage, name);\r\n        console.log(\"gotoStageAsync %s\", name.toString());\r\n        return this.getStageGroupAsync(name.groupName).then(group => {\r\n            let stage = group.stages[name.localName];\r\n            if (stage) {\r\n                this._context.prompt = stage.prompt;\r\n                this._context.options = stage.options;\r\n                // eval(stage.script);\r\n                this._context.currentStage = name;\r\n                return;\r\n            }\r\n            return $.Deferred().reject(new StageMissingError(name));\r\n        });\r\n    }\r\n\r\n    public get context() { return this._context; }\r\n}\r\n"]}