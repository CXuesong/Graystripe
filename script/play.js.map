{"version":3,"sources":["script/play.ts"],"names":[],"mappings":"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","file":"play.js","sourcesContent":["/// <reference path=\"../../typings/index.d.ts\"/>\r\nimport * as Utility from \"./utility\";\r\nimport * as VmUtility from \"./vmUtility\";\r\nimport * as Locale from \"./locale\";\r\nimport * as ObjectModel from \"./objectModel\";\r\nimport * as Ptag from \"./ptag\";\r\nimport { LR } from \"./localization\";\r\n\r\nclass StageHistoryEntry {\r\n    public constructor(public readonly description: string, public readonly selectedOption: string) { }\r\n}\r\n\r\n/**\r\n * An immutable view model.\r\n */\r\nclass StageOptionViewModel {\r\n    public readonly target: string;\r\n    public readonly text: string;\r\n\r\n    public constructor(public readonly model: ObjectModel.StageOption,\r\n        public readonly onClick: (sender: StageOptionViewModel) => void) {\r\n        this.target = model.target;\r\n        this.text = model.text === null || model.text === undefined\r\n            ? Utility.htmlEscape(this.target)\r\n            : Ptag.parseMarkup(model.text);\r\n    }\r\n\r\n    public notifyClick() {\r\n        if (this.onClick) this.onClick(this);\r\n    }\r\n}\r\n\r\nclass CurrentStageViewModel extends VmUtility.LocalizableViewModel {\r\n    public readonly stageName = ko.observable(\"[stage]\");\r\n    public readonly prompt = ko.observable(\"[prompt]\");\r\n    public readonly options = ko.observableArray<StageOptionViewModel>();\r\n\r\n    public constructor(public readonly stageContext: Ptag.StageContext,\r\n        public readonly onOptionClick: (option: StageOptionViewModel) => void) {\r\n        super();\r\n    }\r\n\r\n    public refresh() {\r\n        this.stageName(this.stageContext.currentStage.toString());\r\n        this.prompt(Ptag.parseMarkup(this.stageContext.prompt));\r\n        let opts = <StageOptionViewModel[]>[];\r\n        this.stageContext.options.forEach(opt => {\r\n            opts.push(new StageOptionViewModel(opt, sender => {\r\n                this.onOptionClick(sender);\r\n            }));\r\n        });\r\n        this.options(opts);\r\n    }\r\n}\r\n\r\nclass TabViewModel extends VmUtility.LocalizableViewModel {\r\n    private _IsVisible = false;\r\n\r\n    public get IsVisible() { return this._IsVisible; }\r\n    public set IsVisible(value: boolean) {\r\n        if (this._IsVisible !== value) {\r\n            this._IsVisible = value;\r\n            if (value) this.onShow(); else this.onHide();\r\n        }\r\n    }\r\n\r\n    protected onShow() { }\r\n    protected onHide() { }\r\n}\r\n\r\nclass SaveLoadTabViewModel extends TabViewModel {\r\n    public readonly IsSaving = ko.observable(false);\r\n    public readonly Slots = ko.observableArray();\r\n}\r\n\r\n/**\r\n * play.html main VM.\r\n */\r\nclass PlayerViewModel extends VmUtility.LocalizableViewModel {\r\n    public readonly currentStageVM: CurrentStageViewModel;\r\n    public readonly gameLang = ko.observable(\"\");\r\n\r\n    private readonly _engine = new Ptag.GameEngine();\r\n\r\n    public constructor() {\r\n        super();\r\n        this.currentStageVM = new CurrentStageViewModel(this._engine.context, opt => { this.gotoStageAsync(opt.target); });\r\n        this.gameLang.subscribe(v => { this._engine.setCurrentLocaleAsync(v); });\r\n    }\r\n\r\n    // public get engine() { return this._engine; }\r\n    public openGameAsync() {\r\n        let t = toastr.info(\"<span data-bind=\\\"text: LC('game_loading')\\\">Loading…</span>\", null, { timeOut: 0 });\r\n        this._engine.clear();\r\n        return this._engine.openGameAsync(new URI(window.location.href).hash(\"\").search(\"\").filename(\"data/demo/game.json\").toString())\r\n            .done(() => { this.currentStageVM.refresh(); }).fail(VmUtility.showError)\r\n            .always(() => { t.hide(); });\r\n    }\r\n\r\n    public gotoStageAsync(targetStageName: string) {\r\n        let name = new Ptag.StageName(targetStageName);\r\n        let d = this._engine.gotoStageAsync(name);\r\n        if (d.state() === \"pending\") {\r\n            let t = toastr.info(Utility.htmlEscape(name.toString()), LR.getString(\"stage_loading\"), { timeOut: 0 });\r\n            d.always(() => { t.hide(); });\r\n        }\r\n        return d.done(() => {\r\n            this.currentStageVM.refresh();\r\n        }).fail(VmUtility.showError);\r\n    }\r\n\r\n    public restartGame() {\r\n        if (!confirm(LR.getString(\"game_restart_prompt\")))\r\n            return $.Deferred().resolve();\r\n        return this.gotoStageAsync(\":\").done(() => { toastr.success(LR.getString(\"game_restarted\")); });\r\n    }\r\n\r\n    public saveGame() {\r\n        if (!store.enabled) {\r\n            toastr.error(LR.getString(\"local_storage_not_supported\"));\r\n            return;\r\n        }\r\n        let slot: ObjectModel.SessionSlot = <any>{};\r\n        slot.time = new Date();\r\n        slot.stageContext = this._engine.SaveContext();\r\n        store.set(\"context\", slot);\r\n        toastr.success(LR.getString(\"game_session_saved\"));\r\n    }\r\n\r\n    public loadGame() {\r\n        if (!store.enabled) {\r\n            toastr.error(LR.getString(\"local_storage_not_supported\"));\r\n            return;\r\n        }\r\n        let slot: ObjectModel.SessionSlot = store.get(\"context\");\r\n        if (!slot) {\r\n            toastr.warning(LR.getString(\"game_no_session_to_load\"));\r\n            return $.Deferred().resolve(false);\r\n        }\r\n        if (!window.confirm(LR.getString(\"game_session_load_prompt\")))\r\n            return $.Deferred().resolve(false);\r\n        ObjectModel.reconstructSessionSlot(slot);\r\n        // console.log(slot);\r\n        return this._engine.LoadContextAsync(slot.stageContext)\r\n            .done(() => {\r\n                this.currentStageVM.refresh();\r\n                toastr.success(LR.getString(\"game_session_loaded\"), slot.time.toString());\r\n                return true;\r\n            })\r\n            .fail(VmUtility.showError);\r\n    }\r\n}\r\n\r\nexport let vm = new PlayerViewModel();\r\n\r\nlet t1 = toastr.info(\"Loading localization resource…\");\r\nvm.gameLang(navigator.language);\r\nLocale.initializeAsync().then(() => { return LR.initializeAsync(navigator.language); })\r\n    .always(() => { t1.hide(); })\r\n    .then(() => { document.title = LR.getString(\"ptag\"); return vm.openGameAsync(); })\r\n    .fail(VmUtility.showError);\r\n\r\nconsole.log(vm);\r\nko.applyBindings(vm);\r\n"]}