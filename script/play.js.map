{"version":3,"sources":["script/play.ts"],"names":[],"mappings":"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","file":"play.js","sourcesContent":["/// <reference path=\"../../typings/index.d.ts\"/>\r\nimport * as ObjectModel from \"./objectModel\";\r\nimport * as Utility from \"./utility\";\r\nimport * as Ptag from \"./ptag\";\r\n\r\nclass StageHistoryEntry {\r\n    public constructor(public readonly description: string, public readonly selectedOption: string) { }\r\n}\r\n\r\n/**\r\n * An immutable view model.\r\n */\r\nclass StageOptionViewModel {\r\n    public readonly target: string;\r\n    public readonly text: string;\r\n\r\n    public constructor(public readonly model: ObjectModel.StageOption,\r\n        public readonly onClick: (sender: StageOptionViewModel) => void) {\r\n        this.target = model.target;\r\n        this.text = model.text || Utility.htmlEscape(this.target);\r\n    }\r\n\r\n    public notifyClick() {\r\n        if (this.onClick) this.onClick(this);\r\n    }\r\n}\r\n\r\nclass CurrentStageViewModel {\r\n    public readonly stageName = ko.observable(\"[stage]\");\r\n    public readonly prompt = ko.observable(\"[prompt]\");\r\n    public readonly options = ko.observableArray<StageOptionViewModel>();\r\n\r\n    public constructor(public readonly stageContext: Ptag.StageContext,\r\n        public readonly onOptionClick: (option: StageOptionViewModel) => void) {\r\n    }\r\n\r\n    public refresh() {\r\n        this.stageName(this.stageContext.currentStage.toString());\r\n        this.prompt(this.stageContext.prompt);\r\n        let opts = [];\r\n        this.stageContext.options.forEach(opt => {\r\n            opts.push(new StageOptionViewModel(opt, sender => {\r\n                this.onOptionClick(sender);\r\n            }));\r\n        });\r\n        this.options(opts);\r\n    }\r\n}\r\n\r\nclass TabViewModel {\r\n    private _IsVisible = false;\r\n\r\n    public get IsVisible() { return this._IsVisible; }\r\n    public set IsVisible(value: boolean) {\r\n        if (this._IsVisible !== value) {\r\n            this._IsVisible = value;\r\n            if (value) this.onShow(); else this.onHide();\r\n        }\r\n    }\r\n\r\n    protected onShow() { }\r\n    protected onHide() { }\r\n}\r\n\r\nclass SaveLoadTabViewModel extends TabViewModel {\r\n    public readonly IsSaving = ko.observable(false);\r\n    public readonly Slots = ko.observableArray();\r\n}\r\n\r\n/**\r\n * play.html main VM.\r\n */\r\nclass PlayerViewModel {\r\n    public readonly currentStageVM: CurrentStageViewModel;\r\n    private readonly _engine = new Ptag.GameEngine();\r\n\r\n    public constructor() {\r\n        this.currentStageVM = new CurrentStageViewModel(this._engine.context, opt => { this.gotoStageAsync(opt.target); });\r\n    }\r\n\r\n    // public get engine() { return this._engine; }\r\n    public openGameAsync() {\r\n        let t = toastr.info(\"Loading game…\");\r\n        return this._engine.openGameAsync(new URI(window.location.href).hash(\"\").search(\"\").filename(\"data/demo/game.json\").toString())\r\n            .done(() => {\r\n                this.currentStageVM.refresh();\r\n            }).fail(err => { toastr.error(err); })\r\n            .always(() => { t.hide(); });\r\n    }\r\n\r\n    public gotoStageAsync(targetStageName: string) {\r\n        let name = new Ptag.StageName(targetStageName);\r\n        let d = this._engine.gotoStageAsync(name);\r\n        if (d.state() === \"pending\") {\r\n            let t = toastr.info(\"Loading stage…<br />\" + Utility.htmlEscape(name.toString()));\r\n            d.always(() => { t.hide(); });\r\n        }\r\n        return d.done(() => {\r\n            this.currentStageVM.refresh();\r\n        }).fail(err => { toastr.error(err); });\r\n    }\r\n\r\n    public restartGame() {\r\n        if (!confirm(\"Do you wish to restart the game?\"))\r\n            return $.Deferred().resolve();\r\n        return this.gotoStageAsync(\":\");\r\n    }\r\n\r\n    public saveGame() {\r\n        if (!store.enabled) {\r\n            toastr.error('Local storage is not supported by your browser. Please disable \"Private Mode\", or upgrade to a modern browser.');\r\n            return;\r\n        }\r\n        let slot: ObjectModel.SessionSlot = <any>{};\r\n        slot.time = new Date();\r\n        slot.stageContext = this._engine.SaveContext();\r\n        store.set(\"context\", slot);\r\n        toastr.success(\"Session has been saved to your browser.\");\r\n    }\r\n\r\n    public loadGame() {\r\n        if (!store.enabled) {\r\n            toastr.error('Local storage is not supported by your browser. Please disable \"Private Mode\", or upgrade to a modern browser.');\r\n            return;\r\n        }\r\n        let slot: ObjectModel.SessionSlot = store.get(\"context\");\r\n        if (!slot) {\r\n            toastr.warning(\"No saved session to load.\");\r\n            return $.Deferred().resolve();\r\n        }\r\n        ObjectModel.reconstructSessionSlot(slot);\r\n        console.log(slot);\r\n        return this._engine.LoadContextAsync(slot.stageContext)\r\n            .done(() => {\r\n                this.currentStageVM.refresh();\r\n                toastr.success(\"Session has been loaded. <br />\" + slot.time);\r\n            })\r\n            .fail(err => { toastr.error(err); });\r\n    }\r\n}\r\n\r\nlet vm = new PlayerViewModel();\r\nvm.openGameAsync();\r\nconsole.log(vm);\r\n\r\nko.applyBindings(vm);\r\n"]}